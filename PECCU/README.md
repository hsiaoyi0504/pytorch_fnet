# PECCU

- PECCU is the name of dataset that we are currently trying to run fnet upon
- Take a look of the README.md in the root directory before you read the following stuffs
- To setup a model, you just need to have a json file for configuration and a csv file for specifying the input files:
  - For traning, check the [model/prefs.json](model/prefs.json) and [image\_list\_train.csv](image_list_train.csv) as an example
  - For testing, check the predict\_options.json (see below) and [image\_list\_test.csv](image_list_test.csv) as an example
- The image\_list\_train.csv and image\_list\_test.csv are generated by [generate_image_list.py](generate_image_list.py).
- Since in each our original tiff file, only one z-stack is saved. I merge the z-stacks together by using the [merge\_tiff.py](merge_tiff.py)
- A script for calculating the max intensity project is in [max\_intensity\_project.py](max_intensity_project.py)

## Set up on Great Lakes
``` shell
module load python3.7-anaconda/2020.02

# set up the conda environment for your user account
# You probably need `conda init bash`

# Set up conda environments

# Recommended way (use the environment.yml I export from the conda environment)
## Note that there are two different conda environments due to some compatibility issue of underlying image-processing-related libraries (versions of tifffile required are different)
## MPstain (environment.yml): the environment for using fnet
## MPstain_preprocess (environment_preprocess.yml): the environment for other steps such as analysis, max intensity projection
conda env create -f environment.yml
conda env create -f environment_preprocess.yml

# alternative way (might not work, but it's an illustration of the steps I used earlier to create conda environment from nowhere)
conda create -n MPstain
conda activate MPstain
conda install pytorch==1.6.0 torchvision=0.7.0 cudatoolkit=10.2 -c pytorch
conda install urllib3
conda install quilt3
conda uninstall botocore
conda install botocore
pip install pytorch_toolbelt

# make sure an environment varialbe setting of MKL correctly setup, you will need this to run training and prediction of fnet
export MKL_SERVICE_FORCE_INTEL=1

# use the commands of fnet to train a model, for example
fnet train --json /home/yihsiao/pytorch_fnet/PECCU/model4/prefs.json --gpu_ids 0
fnet predict --json /nfs/turbo/umms-jzsexton/VirtualStaining/data_merged/predictions/predict_options.json
```

